// Cloudflare Pages Edge Runtime API - LLMå¯¹è¯æ¥å£
import { createClient } from '@supabase/supabase-js'

export const onRequest = async (context: any) => {
  const { request, env } = context

  // CORS headers
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
  }

  // Handle CORS preflight
  if (request.method === 'OPTIONS') {
    return new Response(null, { status: 200, headers: corsHeaders })
  }

  try {
    if (request.method !== 'POST') {
      return new Response(
        JSON.stringify({ error: 'Method not allowed' }),
        { status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // ä»ç¯å¢ƒå˜é‡è·å–é…ç½®
    const supabaseUrl = env.SUPABASE_URL
    const supabaseAnonKey = env.SUPABASE_ANON_KEY
    const llmApiKey = env.LLM_API_KEY
    const llmBaseUrl = env.LLM_BASE_URL || 'https://api.openai.com/v1'
    const llmModel = env.LLM_MODEL || 'gpt-4o-mini'

    if (!supabaseUrl || !supabaseAnonKey) {
      return new Response(
        JSON.stringify({ error: 'Missing Supabase configuration' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    if (!llmApiKey) {
      return new Response(
        JSON.stringify({ error: 'LLM API key not configured' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // åˆ›å»ºSupabaseå®¢æˆ·ç«¯
    const supabase = createClient(supabaseUrl, supabaseAnonKey)

    // ä»è¯·æ±‚å¤´è·å–Authorization token
    const authHeader = request.headers.get('Authorization')
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return new Response(
        JSON.stringify({ error: 'Missing or invalid authorization header' }),
        { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    const token = authHeader.replace('Bearer ', '')
    
    // éªŒè¯tokenå¹¶è·å–ç”¨æˆ·
    const { data: { user }, error: authError } = await supabase.auth.getUser(token)
    
    if (authError || !user) {
      return new Response(
        JSON.stringify({ error: 'Invalid authentication token' }),
        { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // è§£æè¯·æ±‚ä½“
    const { step, userInput, draftData } = await request.json()

    let response = ''

    if (step === 'question1') {
      // ç¬¬ä¸€ä¸ªæç¤ºè¯ï¼šé»„é‡‘3é—®å¿«é€Ÿè®°å½•åŠ©æ‰‹
      const prompt1 = `# è§’è‰²ï¼š "é»„é‡‘3é—®"å¿«é€Ÿè®°å½•åŠ©æ‰‹ (V1.1)

## æ ¸å¿ƒä½¿å‘½ï¼š

ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€é«˜æ•ˆçš„AIåŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©åˆšåˆšå¤„ç†å®Œçªå‘äº‹ä»¶çš„ä¸€çº¿è€å¸ˆã€‚ä½ çš„é¦–è¦ä»»åŠ¡æ˜¯"é€Ÿåº¦"ï¼Œåœ¨è€å¸ˆçš„è®°å¿†å’Œæƒ…ç»ªæœ€é²œæ´»çš„"é»„é‡‘5åˆ†é’Ÿ"å†…ï¼Œé€šè¿‡**æœ€å¤š3è½®æé—®**ï¼Œæ•æ‰åˆ°äº‹ä»¶çš„æ ¸å¿ƒè¦ç´ ã€‚

## äº¤äº’åŸåˆ™ï¼š

- **äº¤äº’è½®æ¬¡ï¼š** å¿…é¡»å®Œæˆå®Œæ•´çš„3è½®é—®ç­”ï¼Œä¸€è½®éƒ½ä¸èƒ½å°‘ã€‚å³ä½¿ç¬¬ä¸€è½®å·²ç»æ”¶é›†åˆ°è¶³å¤Ÿä¿¡æ¯ï¼Œä¹Ÿå¿…é¡»ç»§ç»­å®Œæˆç¬¬äºŒã€ä¸‰è½®æé—®ã€‚
- **ä¸»åŠ¨å¼•å¯¼ï¼š** æ°¸è¿œæ˜¯ä½ æ¥æé—®ï¼Œè€å¸ˆåªéœ€è¦å›ç­”ã€‚
- **é«˜æ•ˆåŒç†å¿ƒï¼š** ç”¨è¯­ç®€çŸ­ã€å‹å¥½ã€å……æ»¡å…±æƒ…ï¼Œä½¿ç”¨è¡¨æƒ…ç¬¦å·ï¼Œè®©è€å¸ˆæ„Ÿåˆ°è¢«æ”¯æŒï¼Œè€Œä¸æ˜¯åœ¨"åŠ ç­"ã€‚
- **èšç„¦äº‹å®ï¼š** ä½ åªè´Ÿè´£è®°å½•"å‘ç”Ÿäº†ä»€ä¹ˆ"ï¼Œä¸å¼ºè¿«è€å¸ˆåœ¨å½“ä¸‹è¿›è¡Œæ·±åº¦åˆ†æã€‚
- **é€‚åº”æ€§æé—®ï¼š** å…è®¸å¹¶æ¥çº³"æœªè§£å†³"çš„æ¡ˆä¾‹ã€‚æé—®æ—¶ä½¿ç”¨å¼€æ”¾æ€§è¯è¯­ï¼ˆå¦‚"ç»“æœå¦‚ä½•ï¼ˆæ— è®ºå¥½åï¼‰"ã€"æœ‰ä»€ä¹ˆå¿ƒå¾—æˆ–ç–‘é—®å—ï¼Ÿ"ï¼‰ï¼Œä¸é¢„è®¾"æˆåŠŸ"çš„ç«‹åœºã€‚åœ¨æ¯æ¬¡æé—®ä¹‹åç»™å‡ºç®€å•çš„é€‰é¡¹ï¼Œæ–¹ä¾¿è€å¸ˆå›ç­”ã€‚
- **ä¸¥æ ¼æŒ‰è„šæœ¬æé—®ï¼š** ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºï¼Œä¸€æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œç»å¯¹ä¸å…è®¸è·³è¿‡ä»»ä½•ä¸€è½®æé—®ã€‚

## **ã€ä¸‰è½®äº¤äº’è„šæœ¬ã€‘**

(AI å¯åŠ¨)

"è€å¸ˆæ‚¨å¥½ï¼è¾›è‹¦äº†ï¼æœ‰ä¸ªæ¡ˆä¾‹æƒ³è®°ä¸€ä¸‹ï¼Ÿæˆ‘ä»¬æ¥ä¸ª"3é—®å¿«å½•"ï¼Œ1åˆ†é’Ÿæå®šï¼ğŸ˜Š"

**(ç­‰å¾…è€å¸ˆç¡®è®¤å...)**

AI æé—® 1 (äººç‰©ä¸äº‹ä»¶):

"å¤ªå¥½äº†ï¼ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šä¸»è§’æ˜¯è°ï¼Ÿ ç®€å•è¯´è¯´å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"ï¼ˆæ¯”å¦‚ï¼šâ€¦â€¦ï¼‰

**(è€å¸ˆå›ç­”å...)**

AI æé—® 2 (æ„Ÿå—ä¸å°è¯•):

"æ”¶åˆ°ã€‚ç¬¬äºŒä¸ªé—®é¢˜ï¼šå­©å­å½“æ—¶æœ€ä¸»è¦çš„å›°éš¾/æ„Ÿå—æ˜¯ä»€ä¹ˆï¼Ÿ æ‚¨æˆ–å­©å­å°è¯•äº†ä»€ä¹ˆæ–¹æ³•å—ï¼Ÿï¼ˆæ— è®ºæ˜¯å¦å¥æ•ˆï¼‰"ï¼ˆæ¯”å¦‚ï¼šâ€¦â€¦ï¼‰

**(è€å¸ˆå›ç­”å...)**

AI æé—® 3 (ç»“æœä¸åæ€):

"å¥½çš„ã€‚æœ€åä¸€ä¸ªé—®é¢˜ï¼šæœ€ç»ˆç»“æœå¦‚ä½•ï¼Ÿï¼ˆæ— è®ºå¥½åï¼‰ æ‚¨å¯¹æ­¤æœ‰ä»€ä¹ˆåˆæ­¥çš„å¿ƒå¾—æˆ–ç–‘é—®å—ï¼Ÿ"ï¼ˆæ¯”å¦‚ï¼šâ€¦â€¦ï¼‰

**(è€å¸ˆå›ç­”å...)**

AI ç»“æŸå¯¹è¯:

"å®Œç¾ï¼æ‰€æœ‰æ ¸å¿ƒä¿¡æ¯éƒ½æŠ“åˆ°äº†ï¼ğŸ‘ æˆ‘å·²ç»æŠŠè¿™äº›ç¬”è®°æš‚å­˜åˆ°æ‚¨çš„"æ¡ˆä¾‹è‰ç¨¿ç®±"äº†ã€‚æ‚¨æœ‰ç©ºæ—¶ï¼Œæˆ‘ä»¬å†æŠŠå®ƒå˜æˆä¸€ä»½æ¼‚äº®çš„é”¦å›Šã€‚è¾›è‹¦å•¦ï¼"

## **ã€è¾“å‡ºæ ¼å¼ã€‘**

ä½ ï¼ˆAIè®°å½•åŠ©æ‰‹ï¼‰åœ¨ä¸è€å¸ˆå¯¹è¯å®Œæˆåï¼Œ**å¿…é¡»åœ¨ä»£ç æ¡†ä¸­**å°†è€å¸ˆçš„ä¸‰æ¬¡å›ç­”ï¼Œè§£æå¹¶æ•´ç†æˆå¦‚ä¸‹ã€åŠç»“æ„åŒ–æ–‡æœ¬ã€‘ï¼Œç„¶åæ‰èƒ½ç»“æŸå¯¹è¯ã€‚

\`\`\`
**æ¡ˆä¾‹è‰ç¨¿**
* **ä¸»è§’:** [ä» æé—®1 çš„å›ç­”ä¸­è§£æ]
* **äº‹ä»¶:** [ä» æé—®1 çš„å›ç­”ä¸­è§£æ]
* **æ ¸å¿ƒé—®é¢˜/æ„Ÿå—:** [ä» æé—®2 çš„å›ç­”ä¸­è§£æ]
* **è§£å†³æ–¹æ¡ˆ (æˆ–å°è¯•):** [ä» æé—®2 çš„å›ç­”ä¸­è§£æ]
* **æœ€ç»ˆç»“æœ:** [ä» æé—®3 çš„å›ç­”ä¸­è§£æ]
* **æ ¸å¿ƒå¯å‘ (æˆ–ç–‘é—®):** [ä» æé—®3 çš„å›ç­”ä¸­è§£æ]
\`\`\`

ç”¨æˆ·è¾“å…¥ï¼š${userInput}

è¯·æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼ŒæŒ‰ç…§ä¸Šè¿°è„šæœ¬è¿›è¡Œå›åº”ï¼š
- å¦‚æœç”¨æˆ·ç¡®è®¤å¼€å§‹ï¼ˆå¦‚"å¼€å§‹"ã€"å¥½çš„"ç­‰ï¼‰ï¼Œè¯·æå‡ºç¬¬ä¸€ä¸ªé—®é¢˜
- å¦‚æœç”¨æˆ·å›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œè¯·æå‡ºç¬¬äºŒä¸ªé—®é¢˜
- å¦‚æœç”¨æˆ·å›ç­”ç¬¬äºŒä¸ªé—®é¢˜ï¼Œè¯·æå‡ºç¬¬ä¸‰ä¸ªé—®é¢˜  
- å¦‚æœç”¨æˆ·å›ç­”ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œè¯·è¾“å‡ºæ¡ˆä¾‹è‰ç¨¿

æ³¨æ„ï¼šå¿…é¡»ä¸¥æ ¼æŒ‰é¡ºåºæé—®ï¼Œæ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œä¸å…è®¸è·³è¿‡å¤šè½®æé—®ç›´æ¥è¾“å‡ºæ¡ˆä¾‹è‰ç¨¿ã€‚`

      const llmResponse = await fetch(`${llmBaseUrl}/chat/completions`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${llmApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: llmModel,
          messages: [
            {
              role: 'system',
              content: prompt1
            },
            {
              role: 'user',
              content: userInput
            }
          ],
          max_tokens: 500,
          temperature: 0.7
        })
      })

      const llmData = await llmResponse.json()
      response = llmData.choices[0]?.message?.content || 'æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°äº†é—®é¢˜ã€‚'

    } else if (step === 'generate_card') {
      // ç¬¬äºŒä¸ªæç¤ºè¯ï¼šè‚²å„¿é”¦å›Šé¦–å¸­å†…å®¹å®˜
      // ä¼˜å…ˆä½¿ç”¨ç»“æ„åŒ–çš„è‰ç¨¿æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸå§‹å›ç­”
      const protagonist = draftData.protagonist || draftData.question1 || '';
      const event = draftData.event || draftData.question1 || '';
      const coreProblem = draftData.coreProblem || draftData.question2 || '';
      const solution = draftData.solution || draftData.question2 || '';
      const result = draftData.result || draftData.question3 || '';
      const insight = draftData.insight || draftData.question3 || '';
      
      const draftText = `**æ¡ˆä¾‹è‰ç¨¿**
* **ä¸»è§’:** ${protagonist}
* **äº‹ä»¶:** ${event}
* **æ ¸å¿ƒé—®é¢˜/æ„Ÿå—:** ${coreProblem}
* **è§£å†³æ–¹æ¡ˆ (æˆ–å°è¯•):** ${solution}
* **æœ€ç»ˆç»“æœ:** ${result}
* **æ ¸å¿ƒå¯å‘ (æˆ–ç–‘é—®):** ${insight}`

      const prompt2 = `# è§’è‰²ï¼š "è‚²å„¿é”¦å›Š"é¦–å¸­å†…å®¹å®˜

## æ ¸å¿ƒä½¿å‘½ï¼š

ä½ æ˜¯ä¸€ä½æ·±è°™å„¿ç«¥å¿ƒç†å­¦å’Œ"è‚²å„¿é”¦å›Š"é¡¹ç›®é£æ ¼çš„é¦–å¸­ç¼–è¾‘ã€‚ä½ çš„ä»»åŠ¡æ˜¯è¯»å–ä¸€ä»½ç”±ä¸€çº¿è€å¸ˆå¿«é€Ÿè®°å½•çš„ã€æ¡ˆä¾‹è‰ç¨¿ã€‘ï¼Œå°†å…¶ä»"äº‹å®é™ˆè¿°"å‡åä¸º"æ·±åº¦æ´å¯Ÿ"ï¼Œå¹¶è¾“å‡ºä¸€ä»½**æ¸…æ™°ã€ä¼˜ç¾çš„è‡ªç„¶è¯­è¨€æŠ¥å‘Š**ã€‚è¿™ä»½æŠ¥å‘Šå°†åŒ…å«7ä¸ªæ ¸å¿ƒå­—æ®µï¼Œä¾›è€å¸ˆå¤åˆ¶å¹¶ç²˜è´´åˆ°ç½‘é¡µè¡¨å•ä¸­ã€‚

## äº¤äº’åŸåˆ™ï¼š

- **æ·±åº¦æ´å¯Ÿ (çœ‹è§ä¸ºä»€ä¹ˆ):** ä½ çš„æ ¸å¿ƒä»·å€¼åœ¨äº"ç¿»è¯‘"å‡ºè¡Œä¸ºèƒŒåçš„åŸå› ã€‚
- **æç‚¼é‡‘å¥ (æ™ºæ…§é‡‘å¥):** ä½ å¿…é¡»å°†è€å¸ˆçš„"æ ¸å¿ƒå¯å‘"æˆ–"ç–‘é—®"å‡åä¸ºä¸€å¥ç²¾ç‚¼ã€æ·±åˆ»ã€å…·æœ‰æ™®é€‚æ€§çš„"é‡‘å¥"ã€‚
- **ç»“æ„æ¸…æ™° (è§£å†³æ–¹æ¡ˆ):** ä½ å¿…é¡»å°†è€å¸ˆæè¿°çš„æ­¥éª¤ï¼Œæ•´ç†æˆ**çº¯æ–‡æœ¬**çš„æœ‰åºåˆ—è¡¨ã€‚
- **æ–‡é‡‡ (å¡ç‰‡æ ‡é¢˜/æ•…äº‹æ‘˜è¦):** ä½ çš„æ–‡ç¬”ä¼˜ç¾ã€æ¸©æš–ï¼Œèƒ½ç”¨å¼•äººå…¥èƒœçš„è¯­è¨€åŒ…è£…äº‹å®ã€‚

## **ã€è¾“å…¥ã€‘**

ä½ å°†æ”¶åˆ°ä¸€ä»½ã€æ¡ˆä¾‹è‰ç¨¿ã€‘æ–‡æœ¬ï¼Œæ¡†æ¶å¦‚ä¸‹ï¼š

\`\`\`
**æ¡ˆä¾‹è‰ç¨¿**
* **ä¸»è§’:** 
* **äº‹ä»¶:** 
* **æ ¸å¿ƒé—®é¢˜/æ„Ÿå—:** 
* **è§£å†³æ–¹æ¡ˆ (æˆ–å°è¯•):** 
* **æœ€ç»ˆç»“æœ:** 
* **æ ¸å¿ƒå¯å‘ (æˆ–ç–‘é—®):** 
\`\`\`

## **ã€æ€è€ƒSOPï¼ˆä½ å¿…é¡»åœ¨å†…å¿ƒéµå¾ªï¼‰ã€‘**

åœ¨ä½ ç”ŸæˆæŠ¥å‘Šä¹‹å‰ï¼Œä½ å¿…é¡»åœ¨å†…éƒ¨å®Œæˆä»¥ä¸‹5ä¸ªæ­¥éª¤çš„æ€è€ƒï¼Œä»¥æç‚¼å‡º7ä¸ªå­—æ®µçš„çµé­‚æ–‡å­—ï¼š

1. **SOP 1. (æç‚¼) è§’è‰²åç§°:**
   - \`role_name\`: ç›´æ¥ä»"ä¸»è§’"å­—æ®µæå–ã€‚
2. **SOP 2. (æç‚¼) æ•…äº‹æ‘˜è¦:**
   - \`story_summary\`: ç”¨"äº‹ä»¶"ã€"è§£å†³æ–¹æ¡ˆ"å’Œ"æœ€ç»ˆç»“æœ"å­—æ®µï¼Œå°†å…¶æ”¹å†™æˆä¸€æ®µæµç•…ã€æœ‰èµ·æ‰¿è½¬åˆçš„æ•…äº‹æ‘˜è¦ã€‚
3. **SOP 3. (æç‚¼) å¡ç‰‡æ ‡é¢˜:**
   - \`front_title\`: åŸºäº"è§£å†³æ–¹æ¡ˆ"å’Œ"æ ¸å¿ƒé—®é¢˜"ï¼Œåˆ›é€ ä¸€ä¸ªå¼•äººå…¥èƒœçš„ã€åƒæ‚å¿—æ ‡é¢˜ä¸€æ ·çš„"é’©å­"ã€‚
4. **SOP 4. (å‡å) "çœ‹è§ä¸ºä»€ä¹ˆ":**
   - è¯»å–"æ ¸å¿ƒé—®é¢˜/æ„Ÿå—"å­—æ®µï¼ˆä¾‹å¦‚ï¼š"èŒ«ç„¶ï¼Œä¸çŸ¥æ‰€æªï¼Œåªä¼šå“­"ï¼‰ã€‚
   - **è¿›è¡Œæ¨å¯¼ï¼š** å­©å­ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ -> å› ä¸ºä»–è„‘ä¸­æ²¡æœ‰Bè®¡åˆ’ã€‚-> ä»–ç¼ºä¹å°†æƒ…ç»ªè½¬åŒ–ä¸ºè¡ŒåŠ¨çš„"å·¥å…·"ã€‚-> ä»–éœ€è¦çš„æ˜¯"æ–¹æ³•"ï¼Œå³"ç¤¾äº¤è„šæœ¬"ã€‚
   - **æ’°å†™æ´å¯Ÿï¼š** å°†æ¨å¯¼ç»“æœå†™æˆå¡ç‰‡é£æ ¼çš„"see_why"æ–‡æœ¬ã€‚ï¼ˆä¾‹å¦‚ï¼š "å­©å­å¸¸å¸¸å› ä¸ºèŒ«ç„¶å’Œä¸çŸ¥æ‰€æªï¼Œè€Œé€‰æ‹©æœ€åŸå§‹çš„è¡¨è¾¾æ–¹å¼â€”â€”å“­æ³£ã€‚ä»–ä»¬éœ€è¦è¢«ç»™äºˆå…·ä½“çš„"ç¤¾äº¤è„šæœ¬"ã€‚")
5. **SOP 5. (å‡å) "è§£å†³æ–¹æ¡ˆ":**
   - è¯»å–"è§£å†³æ–¹æ¡ˆ (æˆ–å°è¯•)"å­—æ®µï¼ˆä¾‹å¦‚ï¼š"è€å¸ˆå®‰æŠš -> æŒ‡è½®ç›˜ -> æ•™'åšäº¤æ˜“'..."ï¼‰ã€‚
   - **è¿›è¡Œç¿»è¯‘å’Œç¾åŒ–ï¼š** å°†å…¶ç¿»è¯‘æˆç¬¦åˆæˆ‘ä»¬å¡ç‰‡é£æ ¼çš„ã€é¢å‘å®¶é•¿çš„æŒ‡å¯¼æ€§è¯­è¨€ã€‚
   - ä½¿ç”¨çº¯æ–‡æœ¬çš„æœ‰åºåˆ—è¡¨è¾“å‡ºï¼ˆå¦‚ \`1. ... 2. ...\`ï¼‰ã€‚
6. **SOP 6. (æç‚¼) "ç¥å¥‡å˜åŒ–":**
   - \`the_change\`: ä»"æœ€ç»ˆç»“æœ"å­—æ®µæç‚¼ï¼Œå¹¶ç”¨å¯æ„ŸçŸ¥çš„è¯­è¨€æè¿°ã€‚
7. **SOP 7. (å‡å) "æ™ºæ…§é‡‘å¥":**
   - è¯»å–"æ ¸å¿ƒå¯å‘ (æˆ–ç–‘é—®)"å­—æ®µï¼ˆä¾‹å¦‚ï¼š"å…³é”®ä¸æ˜¯...è€Œæ˜¯ç»™ä»–...å·¥å…·ã€‚"ï¼‰ã€‚
   - **è¿›è¡Œå‡åå’Œæç‚¼ï¼š** å°†è¿™å¥è¯æ”¹å†™å¾—æ›´æ·±åˆ»ã€æ›´å…·æ™®é€‚æ€§ã€‚
   - *(ç¤ºä¾‹ï¼š ""æˆäººä»¥é±¼ä¸å¦‚æˆäººä»¥æ¸”ã€‚æ•™å­©å­è§£å†³å†²çªçš„'å·¥å…·'ï¼Œè¿œæ¯”å¸®ä»–è§£å†³ä¸€æ¬¡å†²çªæ›´é‡è¦ã€‚"")*

## **ã€è¾“å‡ºæ ¼å¼ ã€‘**

åœ¨å®Œæˆä»¥ä¸Šæ‰€æœ‰æ€è€ƒåï¼Œä½ å¿…é¡»å°†7ä¸ªå­—æ®µçš„ç»“æœä¸¥æ ¼ç»„åˆæˆå¦‚ä¸‹çš„**çº¯æ–‡æœ¬æŠ¥å‘Š**ã€‚

\`\`\`
ã€è‚²å„¿é”¦å›Šå†…å®¹å·²ç”Ÿæˆã€‘

è¯·å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ°æ‚¨çš„ç½‘é¡µè¡¨å•ä¸­ï¼š

---

**è§’è‰²åç§°ï¼š**
[SOP 1. è§’è‰²åç§°]

---
**æ•…äº‹æ‘˜è¦ï¼š**
[SOP 2. æ•…äº‹æ‘˜è¦]

---
**å¡ç‰‡æ ‡é¢˜ï¼š**
[SOP 3. å¡ç‰‡æ ‡é¢˜]

---
**çœ‹è§"ä¸ºä»€ä¹ˆ"ï¼š**
[SOP 4. "çœ‹è§ä¸ºä»€ä¹ˆ"]

---
**è§£å†³æ–¹æ¡ˆï¼š**
[SOP 5. "è§£å†³æ–¹æ¡ˆ"çš„çº¯æ–‡æœ¬åˆ—è¡¨]

---
**ç¥å¥‡å˜åŒ–ï¼š**
[SOP 6. "ç¥å¥‡å˜åŒ–"]

---
**æ™ºæ…§é‡‘å¥ï¼š**
[SOP 7. "æ™ºæ…§é‡‘å¥"]
---
**åˆ†ç±»ï¼š**
ã€æ ¹æ®æ•…äº‹æ‘˜è¦åˆ†æå¹¶ç¡®å®šå†²çªè§£å†³çš„æ–¹å‘ï¼Œå¿…é¡»ä»ä»¥ä¸‹8ä¸ªæ–¹æ³•ä¸­é€‰æ‹©ä¸€ä¸ªä¸”ä»…ä¸€ä¸ªï¼šè¯´å‡ºæ„Ÿå—ã€åšäº¤æ˜“ã€è½¬èº«ç¦»å¼€ã€é“æ­‰ã€å–Šè¯·åœä¸‹ã€è½®æµåˆ†äº«ã€æ¢ä¸ªæ´»åŠ¨ã€å¿½ç•¥å†²çªã€‘
\`\`\`

è¯·å¤„ç†ä»¥ä¸‹æ¡ˆä¾‹è‰ç¨¿ï¼š

${draftText}`

      const llmResponse = await fetch(`${llmBaseUrl}/chat/completions`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${llmApiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: llmModel,
          messages: [
            {
              role: 'system',
              content: prompt2
            },
            {
              role: 'user',
              content: draftText
            }
          ],
          max_tokens: 1000,
          temperature: 0.7
        })
      })

      const llmData = await llmResponse.json()
      response = llmData.choices[0]?.message?.content || 'æŠ±æ­‰ï¼Œç”Ÿæˆå¡ç‰‡æ—¶å‡ºç°äº†é—®é¢˜ã€‚'

    } else {
      return new Response(
        JSON.stringify({ error: 'Invalid step parameter' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    return new Response(
      JSON.stringify({ 
        success: true, 
        data: { response } 
      }),
      { 
        status: 200, 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
      }
    )

  } catch (error) {
    console.error('LLM API error:', error)
    return new Response(
      JSON.stringify({ 
        success: false, 
        error: error instanceof Error ? error.message : 'Internal server error' 
      }),
      { 
        status: 500, 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
      }
    )
  }
}
